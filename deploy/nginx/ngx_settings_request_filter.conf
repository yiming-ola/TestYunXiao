map_hash_bucket_size 2048;

split_clients "${http_user_did}" $user_group {
    50%               welcomed;
    *                 uninvited;
}

map $user_group $allow_in {
    "welcomed" 1;
    default 0;
}

map $http_x_forwarded_for $from_office {
    ~*192\.168\.1\.1  1; # 办公室IP
    default 0;
}

map "$allow_in$from_office" $reject {
    "01" 0; # 未开放+在办公室=放行
    "00" 1; # 未开放
    "10" 0; # 开放
    "11" 0; # 开放
    default 1; # 默认关闭直到整段条件判断拿走
}

map $http_user_did $white_did { # 设备id白名单
    ~.*(D2u8fSYHBJFAA20dsFx+H0JizASvPOMLs4NVIt4WA1WEsXb5)$ 1;
    ~.*(DUISxS7d1Z98eY9NwFpXJYyiy2Pcmahxvs42RFVJU3hTN2QxWjk4ZVk5TndGcFhKWXlpeTJQY21haHh2czQyc2h1)$ 1;
    ~.*(DULMwM_Jm9Ngql_Y12RcfYCjZFKKTGqUf0a7RFVMTXdNX0ptOU5ncWxfWTEyUmNmWUNqWkZLS1RHcVVmMGE3c2h1)$ 1;
    ~.*(D2PBFuqD+g6kKJP3bvmljEIzYyiZhB2trkNVIt4WA1WEsXdc)$ 1;
    ~.*(DU090AFF1GCSMJPqd--ZIMSo81SQ0yJ7fU2eRFUwOTBBRkYxR0NTTUpQcWQtLVpJTVNvODFTUTB5SjdmVTJlc2h1)$ 1;
    ~.*(D2rPdsI9WvRVA+ZZxGWjH5A7ILXDmoixR5NVIt4WA1WEsX44)$ 1;
    ~.*(DU2Am9HbH4jCO_BtHEfKKKUzYtkvWiAkyrf8RFUyQW05SGJINGpDT19CdEhFZktLS1V6WXRrdldpQWt5cmY4c2h1)$ 1;
    ~.*(D2SU8+pMCNq8tV7zNKw+fhgBrkSWOHvRIaNVIt4WA1WEsX69)$ 1;
    ~.*(D20WvBQ9nAlNmmgLpqijly40gYqituyIu3NVIt4WA1WEsX53)$ 1;
    ~.*(DUsC-BVxScvHYw7SOB9jxE_t41B2shZ92J48RFVzQy1CVnhTY3ZIWXc3U09COWp4RV90NDFCMnNoWjkySjQ4c2h1)$ 1;
    ~.*(D28eli0RsNvst/1iUiU3aZXkKXWhcoPblSNVIt4WA1WEsXee)$ 1;
    ~.*(D2IfkdN3l046Eeg68NeudM6YQW3CmFTj97NVIt4WA1WEsX95)$ 1;
    ~.*(D23vXciMKW9f+lm+PidjbptwXDVIxLhHoMNVIt4WA1WEsXe3)$ 1;
    ~.*(D23vXciMKW9f+lm+DU4Vu1wNc9IYCegQMxF9RHIYusfkwy2cHk04RFU0VnUxd05jOUlZQ2VnUU14RjlSSElZdXNma3d5MmNIazA0c2h1)$ 1;
    default 0;
}

server {
    listen 80 default_server;
    listen [::]:80 default_server;

    root /home/ecs-user/webroot/php_partying/tutorial/public;

    index index.php index.html index.htm index.nginx-debian.html;

    server_name _;

    add_header X-AB-GROUP $user_group;
    add_header AB-IS-WHITE $white_did;

    # if ($reject = 1) {
    #     return 403 "Server under maintenance, please try later.";
    # }

    location / {
        return 200;
    }

    location ~ \.php$ {
            fastcgi_split_path_info ^(.+\.php)(/.+)$;
            fastcgi_pass unix:/run/php/php7.2-fpm.sock;
            include fastcgi.conf;
            # include the fastcgi_param setting
            include fastcgi_params;

            # refer to https://medium.com/hackernoon/truly-atomic-deployments-with-nginx-and-php-fpm-aed8a8ac1cd9
            fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
    }

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    location ~ /\.ht {
            deny all;
    }
}
