map_hash_bucket_size 4096; # extend map size

split_clients "${http_user_did}" $user_group {
    50%               welcomed;
    *                 uninvited;
}

map $user_group $allow_in {
    "welcomed" 1;
    default 0;
}

map $http_x_forwarded_for $from_office {
    ~*118\.201\.251\.195        1; # 办公室IP
    ~*60\.48\.168\.47   1; # 办公室IP
    ~*61\.183\.129\.50  1; # 办公室IP
    default 0;
}

map "$allow_in$from_office" $reject {
    "01" 0; # 未开放+在办公室=放行
    "00" 1; # 未开放
    "10" 0; # 开放
    "11" 0; # 开放
    default 1; # 默认关闭直到整段条件判断拿走
}

map $http_user_did $white_did { # 设备id白名单
    ~.*(H0JizASvPOMLs4NVIt4WA1WEsXb5)$ 1;
    ~.*(3hTN2QxWjk4ZVk5TndGcFhKWXlpeTJQY21haHh2czQyc2h1)$ 1;
    ~.*(TXdNX0ptOU5ncWxfWTEyUmNmWUNqWkZLS1RHcVVmMGE3c2h1)$ 1;
    ~.*(bvmljEIzYyiZhB2trkNVIt4WA1WEsXdc)$ 1;
    ~.*(ZIMSo81SQ0yJ7fU2eRFUwOTBBRkYxR0NTTUpQcWQtLVpJTVNvODFTUTB5SjdmVTJlc2h1)$ 1;
    ~.*(ZZxGWjH5A7ILXDmoixR5NVIt4WA1WEsX44)$ 1;
    ~.*(BtHEfKKKUzYtkvWiAkyrf8RFUyQW05SGJINGpDT19CdEhFZktLS1V6WXRrdldpQWt5cmY4c2h1)$ 1;
    ~.*(fhgBrkSWOHvRIaNVIt4WA1WEsX69)$ 1;
    ~.*(D20WvBQ9nAlNmmgLpqijly40gYqituyIu3NVIt4WA1WEsX53)$ 1;
    ~.*(t41B2shZ92J48RFVzQy1CVnhTY3ZIWXc3U09COWp4RV90NDFCMnNoWjkySjQ4c2h1)$ 1;
    ~.*(1iUiU3aZXkKXWhcoPblSNVIt4WA1WEsXee)$ 1;
    ~.*(eudM6YQW3CmFTj97NVIt4WA1WEsX95)$ 1;
    ~.*(PidjbptwXDVIxLhHoMNVIt4WA1WEsXe3)$ 1;
    ~.*(FU0VnUxd05jOUlZQ2VnUU14RjlSSElZdXNma3d5MmNIazA0c2h1)$ 1;
    default 0;
}

map $http_user_language $localized_msg {
    default "System upgrading from 7:00PM to 10:00PM (UTC-4 time). After the upgrading, you can log in to the app to claim your rewards..";
    ar "\u062c\u0627\u0631\u064a \u062a\u0631\u0642\u064a\u0629 \u0627\u0644\u062e\u0627\u062f\u0645. \u0648\u0642\u062a \u0627\u0644\u062a\u0631\u0642\u064a\u0629 \u0647\u0648 02:00-05:00. \u0628\u0639\u062f \u0627\u0644\u062a\u0631\u0642\u064a\u0629\u060c \u064a\u0645\u0643\u0646\u0643 \u062a\u0633\u062c\u064a\u0644 \u0627\u0644\u062f\u062e\u0648\u0644 \u0625\u0644\u0649 \u0627\u0644\u062a\u0637\u0628\u064a\u0642 \u0644\u062a\u0644\u0642\u064a \u0645\u0643\u0627\u0641\u0622\u062a \u0627\u0644\u0632\u064a\u0646\u0629.";
    en "System upgrading from 7:00PM to 10:00PM (UTC-4 time). After the upgrading, you can log in to the app to claim your rewards..";
    id "Server sedang ditingkatkan. Waktu peningkatan adalah pukul 06:00-9:00. Setelah peningkatan, Anda dapat login ke aplikasi dan menerima hadiah dekorasi.";
    ja "\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u4e2d\u3001\u304a\u3088\u305d1-3\u6642\u9593\u304b\u304b\u308a\u307e\u3059\u3002\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u5f8c\u30a2\u30d7\u30ea\u306b\u30ed\u30b0\u30a4\u30f3\u3059\u308b\u3068\u5831\u916c\u304c\u3082\u3089\u3048\u307e\u3059\u3002";
    ko "\uc11c\ubc84 \uc5c5\uadf8\ub808\uc774\ub4dc \ud558\uace0 \uc788\uc2b5\ub2c8\ub2e4. \uc5c5\uadf8\ub808\uc774\ub4dc \uc2dc\uac04\uc740 08:00-11:00\uc774\uba70, \uc5c5\uadf8\ub808\uc774\ub4dc \ud6c4 \uc571\uc5d0 \ub85c\uadf8\uc778\ud558\uc2dc\uba74 \ud504\ub85c\ud544 \uc7a5\uc2dd \ubcf4\ub108\uc2a4\ub97c \ubc1b\uc73c\uc2e4 \uc218 \uc788\uc2b5\ub2c8\ub2e4.";
    th "\u0e01\u0e33\u0e25\u0e31\u0e07\u0e2d\u0e31\u0e1b\u0e40\u0e01\u0e23\u0e14\u0e40\u0e0b\u0e34\u0e23\u0e4c\u0e1f\u0e40\u0e27\u0e2d\u0e23\u0e4c \u0e40\u0e27\u0e25\u0e32\u0e2d\u0e31\u0e1b\u0e40\u0e01\u0e23\u0e14\u0e04\u0e37\u0e2d 06.00 - 09.00 \u0e19. \u0e2b\u0e25\u0e31\u0e07\u0e08\u0e32\u0e01\u0e2d\u0e31\u0e1b\u0e40\u0e01\u0e23\u0e14\u0e41\u0e25\u0e49\u0e27 \u0e04\u0e38\u0e13\u0e2a\u0e32\u0e21\u0e32\u0e23\u0e16\u0e40\u0e02\u0e49\u0e32\u0e2a\u0e39\u0e48\u0e23\u0e30\u0e1a\u0e1a\u0e43\u0e19 APP \u0e40\u0e1e\u0e37\u0e48\u0e2d\u0e23\u0e31\u0e1a\u0e23\u0e32\u0e07\u0e27\u0e31\u0e25\u0e15\u0e01\u0e41\u0e15\u0e48\u0e07\u0e44\u0e14\u0e49";
    vi "APP \u0111ang n\u00e2ng c\u1ea5p,th\u1eddi gian n\u00e2ng c\u1ea5p:06:00-9:00, sau khi n\u00e2ng c\u1ea5p \u0111\u0103ng nh\u1eadp v\u00e0o APP s\u1ebd \u0111\u01b0\u1ee3c ph\u1ea7n th\u01b0\u1edfng trang tr\u00ed";
    zh_cn "\u670d\u52a1\u5668\u5347\u7ea7\u4e2d\uff0c\u5347\u7ea7\u65f6\u95f4\u4e3a07:00-10:00\uff0c\u5347\u7ea7\u540e\u767b\u9646app\u5373\u53ef\u9886\u53d6\u88c5\u626e\u5956\u52b1";
    zh_tw "\u670d\u52d9\u5668\u5347\u7d1a\u4e2d\uff0c\u5347\u7d1a\u6642\u9593\u70ba07:00-10:00\uff0c\u5347\u7d1a\u5f8c\u767b\u9678app\u5373\u53ef\u9818\u53d6\u88dd\u626e\u734e\u52f5";
}

server {
        listen 80;
        server_name _;

        root /home/ecs-user/webroot/php_partying/tutorial/public;

        index index.php index.html index.htm index.nginx-debian.html;

        add_header AB-GROUP $user_group;
        add_header IS-WHITE-DID $white_did;
        add_header GROUP_CODE "$allow_in$from_office";

        if ( $reject = 1 && $white_did = 0 ) {
                default_type 'application/json; charset=utf-8';
                add_header User-Status '{"status":403,"msg":"$localized_msg", "refresh_remote_config": 1}';
                return 200 '{"status":403,"msg":"$localized_msg"}';
        }

        location ~ \.php$ {
                include fastcgi.conf;
                fastcgi_split_path_info ^(.+\.php)(/.+)$;
                # NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
                # With php5-cgi alone:
                #fastcgi_pass 127.0.0.1:9000;
                # With php5-fpm:
                fastcgi_buffer_size 128k;
                fastcgi_buffers 32 32k;
                fastcgi_pass unix:/home/ecs-user/.local/var/run/php/php7.2-fpm.sock;
                fastcgi_index index.php;
                # refer to https://medium.com/hackernoon/truly-atomic-deployments-with-nginx-and-php-fpm-aed8a8ac1cd9
                fastcgi_param SCRIPT_FILENAME $realpath_root$fastcgi_script_name;
        }

        location / {
                return 200;
        }

        location ~ /\.ht {
                deny all;
        }
}
